var tim=function(){var e=/{{\s*([a-z0-9_][\\.a-z0-9_]*)\s*}}/gi;return function(t,n){return t.replace(e,function(e,t){for(var r=t.split("."),i=r.length,s=n,o=0;o<i;o++){s=s[r[o]];if(s===void 0)throw"tim: '"+r[o]+"' not found in "+e;if(o===i-1)return s}})}}(),DrawingBoard=function(e,t){var n=this,r='<div class="drawing-board-controls"></div><canvas class="drawing-board-canvas" width={{width}} height={{height}}></canvas>';this.opts=$.extend({width:600,height:600,controls:["Colors","Size","Clear","History"]},t),this.selector=e,this.$el=$(this.selector),this.$el.addClass("drawing-board").css({width:this.opts.width+"px",height:this.opts.height+"px"}).append(tim(r,this.opts)),this.$canvas=this.$el.find("canvas"),this.canvas=this.$canvas.get(0),this.ctx=this.canvas.getContext("2d"),this.reset(),this.initHistory(),this.restoreLocalStorage(),this.initDrawEvents(),this.initControls()};DrawingBoard.prototype.reset=function(){this.ctx.lineCap="round",this.ctx.lineJoin="round",this.ctx.save(),this.ctx.fillStyle="#ffffff",this.ctx.fillRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height),this.ctx.restore(),this.saveLocalStorage()},DrawingBoard.prototype.initControls=function(){for(var e=0;e<this.opts.controls.length;e++)if(window.DrawingBoard.Control[this.opts.controls[e]]){var t=new window.DrawingBoard.Control[this.opts.controls[e]](this);this.addControl(t)}},DrawingBoard.prototype.initHistory=function(){this.history=[]},DrawingBoard.prototype.restoreLocalStorage=function(){window.localStorage&&localStorage.getItem("drawing-board-image")!==null&&this.restoreImg(localStorage.getItem("drawing-board-image"))},DrawingBoard.prototype.initDrawEvents=function(){var e=this;this.isDrawing=!1,this.inputCoords={x:null,y:null},this.mouseCoords={x:null,y:null},this.midInputCoords=this.inputCoords,this.$canvas.on("mousedown",function(t){e._onMouseDown(t,e._getMouseCoordinates(t))}),this.$canvas.on("mouseup",function(t){e._onMouseUp(t,e._getMouseCoordinates(t))}),this.$canvas.on("mousemove",function(t){e._onMouseMove(t,e._getMouseCoordinates(t))}),this.$canvas.on("mouseover",function(t){e.inputCoords=e._getMouseCoordinates(t),t.which!==1&&(e.isDrawing=!1)}),this.$canvas.on("mouseout",function(e){}),webkitRequestAnimationFrame($.proxy(function(){this.draw()},this))},DrawingBoard.prototype.restoreImg=function(e){var t=this;img=new Image,img.onload=function(){t.ctx.drawImage(img,0,0)},img.src=e},DrawingBoard.prototype._getImage=function(){return this.canvas.toDataURL("image/png")},DrawingBoard.prototype.saveHistory=function(){this.history===undefined&&(this.history=[]);while(this.history.length>30)this.history.shift();this.history.push(this._getImage())},DrawingBoard.prototype.goBackInHistory=function(){this.history.length&&this.restoreImg(this.history.pop()),this.saveLocalStorage()},DrawingBoard.prototype.saveLocalStorage=function(){window.localStorage&&localStorage.setItem("drawing-board-image",this._getImage())},DrawingBoard.prototype.draw=function(){if(this.isDrawing){this.ctx.beginPath();var e={x:this.inputCoords.x+this.mouseCoords.x>>1,y:this.inputCoords.y+this.mouseCoords.y>>1};this.ctx.moveTo(e.x,e.y),this.ctx.quadraticCurveTo(this.inputCoords.x,this.inputCoords.y,this.midInputCoords.x,this.midInputCoords.y),this.ctx.stroke(),this.inputCoords=this.mouseCoords,this.midInputCoords=e}webkitRequestAnimationFrame($.proxy(function(){this.draw()},this))},DrawingBoard.prototype._onMouseDown=function(e,t){this.saveHistory(),this.isDrawing=!0,this.inputCoords=t,this.midInputCoords={x:this.inputCoords.x+t.x>>1,y:this.inputCoords.y+t.y>>1}},DrawingBoard.prototype._onMouseMove=function(e,t){this.mouseCoords=t},DrawingBoard.prototype._onMouseUp=function(e,t){this.isDrawing&&(this.isDrawing=!1,this.saveLocalStorage())},DrawingBoard.prototype._getMouseCoordinates=function(e){return{x:e.pageX-this.$canvas.offset().left,y:e.pageY-this.$canvas.offset().top}},DrawingBoard.prototype.addControl=function(e){this.$el.find(".drawing-board-controls").append(e.$el)},DrawingBoard.Control={},DrawingBoard.Control.Colors=function(e,t){this.board=e,this.opts=$.extend({defaultColor:"rgba(255, 191, 127, 1)"},t),this.board.ctx.strokeStyle=this.opts.defaultColor,this.el='<div class="drawing-board-control drawing-board-control-colors"><div class="drawing-board-control-colors-current" style="background-color: '+this.board.ctx.strokeStyle+'"></div>'+'<div class="drawing-board-control-colors-rainbows">';var n=this;this.fillWithRainbow(.75),this.fillWithRainbow(.5),this.fillWithRainbow(.25),this.el+="</div>",this.$el=$(this.el),this.$el.on("click",".drawing-board-control-colors-picker",function(e){n.board.ctx.strokeStyle=$(this).attr("data-color"),n.$el.find(".drawing-board-control-colors-current").css("background-color",$(this).attr("data-color")),e.preventDefault()})},DrawingBoard.Control.Colors.prototype={rgba:function(e,t,n,r){return{r:e,g:t,b:n,a:r,toString:function(){return"rgba("+e+", "+t+", "+n+", "+r+")"}}},hsl:function(e,t,n){return{h:e,s:t,l:n,toString:function(){return"hsl("+e+", "+t*100+"%, "+n*100+"%)"}}},hex2Rgba:function(e){var t=parseInt(e.substring(1),16);return this.rgba(t>>16,t>>8&255,t&255,1)},hsl2Rgba:function(e){function u(e,t,n){return n<0&&(n+=1),n>1&&(n-=1),n<1/6?e+(t-e)*6*n:n<.5?t:n<2/3?e+(t-e)*(2/3-n)*6:e}var t=e.h/360,n=e.s,r=e.l,i,s,o;if(n===0)i=s=o=r;else{var a=r<.5?r*(1+n):r+n-r*n,f=2*r-a;i=Math.floor(u(f,a,t+1/3)*255),s=Math.floor(u(f,a,t)*255),o=Math.floor(u(f,a,t-1/3)*255)}return this.rgba(i,s,o,1)},fillWithRainbow:function(e){var t=0,n=null,r='<div class="drawing-board-control-colors-picker" data-color="{{color}}" style="background-color: {{color}}"></div>';this.el+='<div class="drawing-board-control-colors-rainbow">',e==.25&&(n=this.rgba(0,0,0,1)),e==.5&&(n=this.rgba(150,150,150,1)),e==.75&&(n=this.rgba(255,255,255,1)),n!==null&&(this.el+=tim(r,{color:n.toString()}));while(t<=330)this.el+=tim(r,{color:this.hsl2Rgba(this.hsl(t-60,1,e)).toString()}),t+=30;this.el+="</div>"}},DrawingBoard.Control.Navigation=function(e,t){this.board=e,this.opts=$.extend({backButton:!0,forwardButton:!0,resetButton:!0},t);var n=this,r='<div class="drawing-board-control drawing-board-control-navigation">';this.opts.backButton&&(r+='<button class="drawing-board-control-navigation-back" title="Annuler la dernière action">&larr;</button>'),this.opts.forwardButton&&(r+='<button class="drawing-board-control-navigation-forward" title="Recommencer la dernière action">&rarr;</button>'),this.opts.resetButton&&(r+='<button class="drawing-board-control-navigation-reset" title="Effacer tout">×</button>'),r+="</div>",this.$el=$(r),this.opts.backButton&&this.$el.on("click",".drawing-board-control-navigation-back",function(e){n.board.goBackInHistory(),e.preventDefault()}),this.opts.forwardButton&&this.$el.on("click",".drawing-board-control-navigation-forward",function(e){e.preventDefault()}),this.opts.resetButton&&this.$el.on("click",".drawing-board-control-navigation-reset",function(e){n.board.reset(),e.preventDefault()})},DrawingBoard.Control.Size=function(e){this.board=e;var t=this,n='<div class="drawing-board-control drawing-board-control-size" title="Taille du pinceau : 10"><input type="range" min="1" max="50" value="10" class="drawing-board-control-size-input"><span class="drawing-board-control-size-label"></span></div>';this.$el=$(n),this.$el.on("change","input",function(e){t.updateView($(this).val()),e.preventDefault()}),this.updateView(this.$el.find("input").val())},DrawingBoard.Control.Size.prototype.updateView=function(e){this.board.ctx.lineWidth=e,this.$el.find(".drawing-board-control-size-label").css({width:e+"px",height:e+"px",borderRadius:e+"px"}),this.$el.attr("title","Taille du pinceau : "+e)};