var DrawingBoard=function(e,t){var n=this,r='<div class="drawing-board-controls"></div><div class="drawing-board-canvas-wrapper"><canvas class="drawing-board-canvas"></canvas><div class="drawing-board-cursor hidden"></div></div>';this.opts=$.extend({controls:["Colors","Size","Navigation"],defaultBgColor:"#ffffff",localStorage:!0},t),this.$el=$(document.getElementById(e));if(!this.$el.length)return!1;this.$el.addClass("drawing-board").append(DrawingBoard.Utils.tpl(r,this.opts)),this.dom={$canvasWrapper:this.$el.find(".drawing-board-canvas-wrapper"),$canvas:this.$el.find("canvas"),$cursor:this.$el.find(".drawing-board-cursor"),$controls:this.$el.find(".drawing-board-controls")},this.canvas=this.dom.$canvas.get(0),this.ctx=this.canvas.getContext("2d"),this.initControls(),this.reset({history:!1,localStorage:!1}),this.initHistory(),this.restoreLocalStorage(),this.initDrawEvents()};DrawingBoard.prototype.reset=function(e){e=$.extend({color:this.opts.defaultBgColor,history:!0,localStorage:!0},e);var t=this.$el.width()-DrawingBoard.Utils.elementBorderWidth(this.$el)-DrawingBoard.Utils.elementBorderWidth(this.dom.$canvasWrapper,!0,!0),n=this.$el.height()-DrawingBoard.Utils.elementBorderHeight(this.$el)-this.dom.$controls.height()-DrawingBoard.Utils.elementBorderHeight(this.dom.$controls,!1,!0)-parseInt(this.dom.$controls.css("margin-bottom").replace("px",""),10)-DrawingBoard.Utils.elementBorderHeight(this.dom.$canvasWrapper);this.dom.$canvasWrapper.css("width",t+"px"),this.dom.$canvasWrapper.css("height",n+"px"),this.canvas.width=t,this.canvas.height=n,this.ctx.lineCap="round",this.ctx.lineJoin="round",this.ctx.save(),this.ctx.fillStyle=e.color,this.ctx.fillRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height),this.ctx.restore(),e.history&&this.saveHistory(),e.localStorage&&this.saveLocalStorage();if(this.controls)for(var r=this.controls.length-1;r>=0;r--)typeof this.controls[r].reset=="function"&&this.controls[r].reset()},DrawingBoard.prototype.initHistory=function(){this.history={values:[],position:0},this.saveHistory()},DrawingBoard.prototype.saveHistory=function(){while(this.history.values.length>30)this.history.values.shift();this.history.position!==0&&this.history.position!==this.history.values.length?(this.history.values=this.history.values.slice(0,this.history.position),this.history.position++):this.history.position=this.history.values.length+1,this.history.values.push(this.getImg())},DrawingBoard.prototype._goThroughHistory=function(e){if(e&&this.history.position==this.history.values.length||!e&&this.history.position==1)return;var t=e?this.history.position+1:this.history.position-1;this.history.values.length&&this.history.values[t-1]!==undefined&&(this.history.position=t,this.restoreImg(this.history.values[this.history.position-1])),this.saveLocalStorage()},DrawingBoard.prototype.goBackInHistory=function(){this._goThroughHistory(!1)},DrawingBoard.prototype.goForthInHistory=function(){this._goThroughHistory(!0)},DrawingBoard.prototype.restoreImg=function(e){var t=this;img=new Image,img.onload=function(){t.ctx.drawImage(img,0,0)},img.src=e},DrawingBoard.prototype.getImg=function(){return this.canvas.toDataURL("image/png")},DrawingBoard.prototype.downloadImg=function(){var e=this.getImg();e=e.replace("image/png","image/octet-stream"),window.location.href=e},DrawingBoard.prototype.restoreLocalStorage=function(){this.opts.localStorage&&window.localStorage&&localStorage.getItem("drawing-board-image")!==null&&this.restoreImg(localStorage.getItem("drawing-board-image"))},DrawingBoard.prototype.saveLocalStorage=function(){this.opts.localStorage&&window.localStorage&&localStorage.setItem("drawing-board-image",this.getImg())},DrawingBoard.prototype.initDrawEvents=function(){var e=this;this.isDrawing=!1,this.isMouseHovering=!1,this.coords={},this.coords.old=this.coords.current=this.coords.oldMid={x:0,y:0},this.dom.$canvas.on("mousedown touchstart",function(t){e._onInputStart(t,e._getInputCoords(t))}),this.dom.$canvas.on("mousemove touchmove",function(t){e._onInputMove(t,e._getInputCoords(t))}),this.dom.$canvas.on("mousemove",function(e){}),this.dom.$canvas.on("mouseup touchend",function(t){e._onInputStop(t,e._getInputCoords(t))}),this.dom.$canvas.on("mouseover",function(t){e._onMouseOver(t,e._getInputCoords(t))}),this.dom.$canvas.on("mouseout",function(t){e._onMouseOut(t,e._getInputCoords(t))}),requestAnimationFrame($.proxy(function(){this.draw()},this))},DrawingBoard.prototype.draw=function(){if(this.ctx.lineWidth>10&&this.isMouseHovering){this.dom.$cursor.css({width:this.ctx.lineWidth+"px",height:this.ctx.lineWidth+"px"});var e=DrawingBoard.Utils.tpl("translateX({{x}}px) translateY({{y}}px)",{x:this.coords.current.x-this.ctx.lineWidth/2,y:this.coords.current.y-this.ctx.lineWidth/2});this.dom.$cursor.css({transform:e,"-webkit-transform":e,"-ms-transform":e}),this.dom.$cursor.removeClass("drawing-board-utils-hidden")}else this.dom.$canvas.css("cursor","crosshair"),this.dom.$cursor.addClass("drawing-board-utils-hidden");if(this.isDrawing){var t=this._getMidInputCoords(this.coords.current);this.ctx.beginPath(),this.ctx.moveTo(t.x,t.y),this.ctx.quadraticCurveTo(this.coords.old.x,this.coords.old.y,this.coords.oldMid.x,this.coords.oldMid.y),this.ctx.stroke(),this.coords.old=this.coords.current,this.coords.oldMid=t}requestAnimationFrame($.proxy(function(){this.draw()},this))},DrawingBoard.prototype._onInputStart=function(e,t){this.coords.current=this.coords.old=t,this.coords.oldMid=this._getMidInputCoords(t),this.isDrawing=!0,e.preventDefault()},DrawingBoard.prototype._onInputMove=function(e,t){this.coords.current=t,e.preventDefault()},DrawingBoard.prototype._onInputStop=function(e,t){this.isDrawing&&(!e.touches||e.touches.length===0)&&(this.isDrawing=!1,this.saveHistory(),this.saveLocalStorage(),e.preventDefault())},DrawingBoard.prototype._onMouseOver=function(e,t){this.isMouseHovering=!0,this.coords.old=this._getInputCoords(e),this.coords.oldMid=this._getMidInputCoords(this.coords.old),e.which!==1&&(this.isDrawing=!1)},DrawingBoard.prototype._onMouseOut=function(e,t){this.isMouseHovering=!1},DrawingBoard.prototype._getInputCoords=function(e){var t,n;return e.touches&&e.touches.length==1?(t=e.touches[0].pageX,n=e.touches[0].pageY):(t=e.pageX,n=e.pageY),{x:t-this.dom.$canvas.offset().left,y:n-this.dom.$canvas.offset().top}},DrawingBoard.prototype._getMidInputCoords=function(e){return{x:this.coords.old.x+e.x>>1,y:this.coords.old.y+e.y>>1}},DrawingBoard.prototype.initControls=function(){this.controls=[];for(var e=0;e<this.opts.controls.length;e++){var t=new window.DrawingBoard.Control[this.opts.controls[e]](this);this.controls.push(t),this.addControl(t)}},DrawingBoard.prototype.addControl=function(e){e.board||(e.board=this),this.dom.$controls.append(e.$el)},DrawingBoard.Control={},DrawingBoard.Utils={},DrawingBoard.Utils.tpl=function(){"use strict";var e="{{",t="}}",n="[a-z0-9_][\\.a-z0-9_]*",r=new RegExp(e+"\\s*("+n+")\\s*"+t,"gi"),i;return function(e,t){return e.replace(r,function(e,n){var r=n.split("."),s=r.length,o=t,u=0;for(;u<s;u++){o=o[r[u]];if(o===i)throw"tim: '"+r[u]+"' not found in "+e;if(u===s-1)return o}})}}(),DrawingBoard.Utils._elementBorderSize=function(e,t,n,r){t=!!t||!0,n=!!n||!1;var i=0,s;r=="width"?(s=["border-left-width","border-right-width"],t&&s.push("padding-left","padding-right"),n&&s.push("margin-left","margin-right")):(s=["border-top-width","border-bottom-width"],t&&s.push("padding-top","padding-bottom"),n&&s.push("margin-top","margin-bottom"));for(var o=s.length-1;o>=0;o--)i+=parseInt(e.css(s[o]).replace("px",""),10);return i},DrawingBoard.Utils.elementBorderWidth=function(e,t,n){return DrawingBoard.Utils._elementBorderSize(e,t,n,"width")},DrawingBoard.Utils.elementBorderHeight=function(e,t,n){return DrawingBoard.Utils._elementBorderSize(e,t,n,"height")},DrawingBoard.Control.Colors=function(e,t){this.board=e||null,this.opts=$.extend({defaultColor:"rgba(0, 0, 0, 1)"},t),this.board.ctx.strokeStyle=this.opts.defaultColor,this.el='<div class="drawing-board-control drawing-board-control-colors"><div class="drawing-board-control-colors-current" style="background-color: '+this.board.ctx.strokeStyle+'" data-color="'+this.board.ctx.strokeStyle+'"></div>'+'<div class="drawing-board-control-colors-rainbows">';var n=this;this.fillWithRainbow(.75),this.fillWithRainbow(.5),this.fillWithRainbow(.25),this.el+="</div>",this.$el=$(this.el),this.$el.on("click",".drawing-board-control-colors-picker",function(e){n.board.ctx.strokeStyle=$(this).attr("data-color"),n.$el.find(".drawing-board-control-colors-current").css("background-color",$(this).attr("data-color")).attr("data-color",$(this).attr("data-color")),e.preventDefault()}),this.$el.on("click",".drawing-board-control-colors-current",function(e){n.board.reset({color:$(this).attr("data-color")}),e.preventDefault()})},DrawingBoard.Control.Colors.prototype={rgba:function(e,t,n,r){return{r:e,g:t,b:n,a:r,toString:function(){return"rgba("+e+", "+t+", "+n+", "+r+")"}}},hsl:function(e,t,n){return{h:e,s:t,l:n,toString:function(){return"hsl("+e+", "+t*100+"%, "+n*100+"%)"}}},hex2Rgba:function(e){var t=parseInt(e.substring(1),16);return this.rgba(t>>16,t>>8&255,t&255,1)},hsl2Rgba:function(e){function u(e,t,n){return n<0&&(n+=1),n>1&&(n-=1),n<1/6?e+(t-e)*6*n:n<.5?t:n<2/3?e+(t-e)*(2/3-n)*6:e}var t=e.h/360,n=e.s,r=e.l,i,s,o;if(n===0)i=s=o=r;else{var a=r<.5?r*(1+n):r+n-r*n,f=2*r-a;i=Math.floor(u(f,a,t+1/3)*255),s=Math.floor(u(f,a,t)*255),o=Math.floor(u(f,a,t-1/3)*255)}return this.rgba(i,s,o,1)},fillWithRainbow:function(e){var t=0,n=null,r='<div class="drawing-board-control-colors-picker" data-color="{{color}}" style="background-color: {{color}}"></div>';this.el+='<div class="drawing-board-control-colors-rainbow">',e==.25&&(n=this.rgba(0,0,0,1)),e==.5&&(n=this.rgba(150,150,150,1)),e==.75&&(n=this.rgba(255,255,255,1)),n!==null&&(this.el+=DrawingBoard.Utils.tpl(r,{color:n.toString()}));while(t<=330)this.el+=DrawingBoard.Utils.tpl(r,{color:this.hsl2Rgba(this.hsl(t-60,1,e)).toString()}),t+=30;this.el+="</div>"}},DrawingBoard.Control.Navigation=function(e,t){this.board=e||null,this.opts=$.extend({backButton:!0,forwardButton:!0,resetButton:!0},t);var n=this,r='<div class="drawing-board-control drawing-board-control-navigation">';this.opts.backButton&&(r+='<button class="drawing-board-control-navigation-back">&larr;</button>'),this.opts.forwardButton&&(r+='<button class="drawing-board-control-navigation-forward">&rarr;</button>'),this.opts.resetButton&&(r+='<button class="drawing-board-control-navigation-reset">×</button>'),r+="</div>",this.$el=$(r),this.opts.backButton&&this.$el.on("click",".drawing-board-control-navigation-back",function(e){n.board.goBackInHistory(),e.preventDefault()}),this.opts.forwardButton&&this.$el.on("click",".drawing-board-control-navigation-forward",function(e){n.board.goForthInHistory(),e.preventDefault()}),this.opts.resetButton&&this.$el.on("click",".drawing-board-control-navigation-reset",function(e){n.board.reset(),e.preventDefault()})},DrawingBoard.Control.Size=function(e){this.board=e||null;var t=this,n='<div class="drawing-board-control drawing-board-control-size"><div class="drawing-board-control-inner"><input type="range" min="1" max="50" value="10" step="1" class="drawing-board-control-size-input"><span class="drawing-board-control-size-label"></span></div></div>';this.$el=$(n),this.$el.on("change","input",function(e){t.updateView($(this).val()),e.preventDefault()})},DrawingBoard.Control.Size.prototype={reset:function(){this.updateView(this.$el.find("input").val())},updateView:function(e){this.board.ctx.lineWidth=e,this.$el.find(".drawing-board-control-size-label").css({width:e+"px",height:e+"px",borderRadius:e+"px"})}},DrawingBoard.Control.Download=function(e){this.board=e||null;var t=this,n='<div class="drawing-board-control drawing-board-control-download">';n+='<button class="drawing-board-control-download-button">⤓</button>',n+="</div>",this.$el=$(n),this.$el.on("click",".drawing-board-control-download-button",function(e){t.board.downloadImg(),e.preventDefault()})};