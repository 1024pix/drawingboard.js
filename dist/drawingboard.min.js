var DrawingBoard=function(a,b){var c=this,d='<div class="drawing-board-controls"></div><div class="drawing-board-canvas-wrapper"><canvas class="drawing-board-canvas"></canvas><div class="drawing-board-cursor hidden"></div></div>';this.opts=$.extend({controls:["Colors","Size","Navigation"],defaultBgColor:"#ffffff",localStorage:!0},b),this.$el=$(document.getElementById(a));if(!this.$el.length)return!1;this.$el.addClass("drawing-board").append(DrawingBoard.Utils.tpl(d,this.opts)),this.dom={$canvas:this.$el.find("canvas"),$cursor:this.$el.find(".drawing-board-cursor"),$controls:this.$el.find(".drawing-board-controls")},this.canvas=this.dom.$canvas.get(0),this.ctx=this.canvas.getContext("2d"),this.initControls(),this.reset({history:!1,localStorage:!1}),this.initHistory(),this.restoreLocalStorage(),this.initDrawEvents(),$(window).on("resize",function(a){c._updateSize()})};DrawingBoard.prototype._updateSize=function(){this.canvas.width=this.$el.width(),this.canvas.height=this.$el.height()-this.dom.$controls.height()},DrawingBoard.prototype.reset=function(a){a=$.extend({color:this.opts.defaultBgColor,history:!0,localStorage:!0},a),this._updateSize(),this.ctx.lineCap="round",this.ctx.lineJoin="round",this.ctx.save(),this.ctx.fillStyle=a.color,this.ctx.fillRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height),this.ctx.restore(),a.history&&this.saveHistory(),a.localStorage&&this.saveLocalStorage()},DrawingBoard.prototype.initHistory=function(){this.history={values:[],position:0},this.saveHistory()},DrawingBoard.prototype.saveHistory=function(){while(this.history.values.length>30)this.history.values.shift();this.history.position!==0&&this.history.position!==this.history.values.length?(this.history.values=this.history.values.slice(0,this.history.position),this.history.position++):this.history.position=this.history.values.length+1,this.history.values.push(this.getImg())},DrawingBoard.prototype._goThroughHistory=function(a){if(a&&this.history.position==this.history.values.length||!a&&this.history.position==1)return;var b=a?this.history.position+1:this.history.position-1;this.history.values.length&&this.history.values[b-1]!==undefined&&(this.history.position=b,this.restoreImg(this.history.values[this.history.position-1])),this.saveLocalStorage()},DrawingBoard.prototype.goBackInHistory=function(){this._goThroughHistory(!1)},DrawingBoard.prototype.goForthInHistory=function(){this._goThroughHistory(!0)},DrawingBoard.prototype.restoreImg=function(a){var b=this;img=new Image,img.onload=function(){b.ctx.drawImage(img,0,0)},img.src=a},DrawingBoard.prototype.getImg=function(){return this.canvas.toDataURL("image/png")},DrawingBoard.prototype.restoreLocalStorage=function(){this.opts.localStorage&&window.localStorage&&localStorage.getItem("drawing-board-image")!==null&&this.restoreImg(localStorage.getItem("drawing-board-image"))},DrawingBoard.prototype.saveLocalStorage=function(){this.opts.localStorage&&window.localStorage&&localStorage.setItem("drawing-board-image",this.getImg())},DrawingBoard.prototype.initDrawEvents=function(){var a=this;this.isDrawing=!1,this.coords={},this.coords.old=this.coords.current=this.coords.oldMid={x:0,y:0},this.dom.$canvas.on("mousedown touchstart",function(b){a._onInputStart(b,a._getInputCoords(b))}),this.dom.$canvas.on("mousemove touchmove",function(b){a._onInputMove(b,a._getInputCoords(b))}),this.dom.$canvas.on("mousemove",function(a){}),this.dom.$canvas.on("mouseup touchend",function(b){a._onInputStop(b,a._getInputCoords(b))}),this.dom.$canvas.on("mouseover",function(b){a._onMouseOver(b,a._getInputCoords(b))}),this.dom.$canvas.on("mouseout",function(a){}),requestAnimationFrame($.proxy(function(){this.draw()},this))},DrawingBoard.prototype.draw=function(){if(this.ctx.lineWidth>10&&this.dom.$canvas.is(":hover")){this.dom.$cursor.css({width:this.ctx.lineWidth+"px",height:this.ctx.lineWidth+"px"});var a=DrawingBoard.Utils.tpl("translateX({{x}}px) translateY({{y}}px)",{x:this.coords.current.x-this.ctx.lineWidth/2,y:this.coords.current.y-this.ctx.lineWidth/2});this.dom.$cursor.css({transform:a,"-webkit-transform":a,"-ms-transform":a}),this.dom.$cursor.removeClass("drawing-board-utils-hidden")}else this.dom.$canvas.css("cursor","crosshair"),this.dom.$cursor.addClass("drawing-board-utils-hidden");if(this.isDrawing){var b=this._getMidInputCoords(this.coords.current);this.ctx.beginPath(),this.ctx.moveTo(b.x,b.y),this.ctx.quadraticCurveTo(this.coords.old.x,this.coords.old.y,this.coords.oldMid.x,this.coords.oldMid.y),this.ctx.stroke(),this.coords.old=this.coords.current,this.coords.oldMid=b}requestAnimationFrame($.proxy(function(){this.draw()},this))},DrawingBoard.prototype._onInputStart=function(a,b){this.coords.current=this.coords.old=b,this.coords.oldMid=this._getMidInputCoords(b),this.isDrawing=!0,a.preventDefault()},DrawingBoard.prototype._onInputMove=function(a,b){this.coords.current=b,a.preventDefault()},DrawingBoard.prototype._onInputStop=function(a,b){this.isDrawing&&(!a.touches||a.touches.length===0)&&(this.isDrawing=!1,this.saveHistory(),this.saveLocalStorage(),a.preventDefault())},DrawingBoard.prototype._onMouseOver=function(a,b){this.coords.old=this._getInputCoords(a),this.coords.oldMid=this._getMidInputCoords(this.coords.old),a.which!==1&&(this.isDrawing=!1)},DrawingBoard.prototype._getInputCoords=function(a){var b,c;return a.touches&&a.touches.length==1?(b=a.touches[0].pageX,c=a.touches[0].pageY):(b=a.pageX,c=a.pageY),{x:b-this.dom.$canvas.offset().left,y:c-this.dom.$canvas.offset().top}},DrawingBoard.prototype._getMidInputCoords=function(a){return{x:this.coords.old.x+a.x>>1,y:this.coords.old.y+a.y>>1}},DrawingBoard.prototype.initControls=function(){for(var a=0;a<this.opts.controls.length;a++){var b=new window.DrawingBoard.Control[this.opts.controls[a]](this);this.addControl(b)}},DrawingBoard.prototype.addControl=function(a){this.dom.$controls.append(a.$el)},DrawingBoard.Control={},DrawingBoard.Utils={},DrawingBoard.Utils.tpl=function(){"use strict";var a="{{",b="}}",c="[a-z0-9_][\\.a-z0-9_]*",d=new RegExp(a+"\\s*("+c+")\\s*"+b,"gi"),e;return function(a,b){return a.replace(d,function(a,c){var d=c.split("."),f=d.length,g=b,h=0;for(;h<f;h++){g=g[d[h]];if(g===e)throw"tim: '"+d[h]+"' not found in "+a;if(h===f-1)return g}})}}(),DrawingBoard.Control.Colors=function(a,b){this.board=a,this.opts=$.extend({defaultColor:"rgba(0, 0, 0, 1)"},b),this.board.ctx.strokeStyle=this.opts.defaultColor,this.el='<div class="drawing-board-control drawing-board-control-colors"><div class="drawing-board-control-colors-current" style="background-color: '+this.board.ctx.strokeStyle+'"></div>'+'<div class="drawing-board-control-colors-rainbows">';var c=this;this.fillWithRainbow(.75),this.fillWithRainbow(.5),this.fillWithRainbow(.25),this.el+="</div>",this.$el=$(this.el),this.$el.on("click",".drawing-board-control-colors-picker",function(a){c.board.ctx.strokeStyle=$(this).attr("data-color"),c.$el.find(".drawing-board-control-colors-current").css("background-color",$(this).attr("data-color")).attr("data-color",$(this).attr("data-color")),a.preventDefault()}),this.$el.on("click",".drawing-board-control-colors-current",function(a){c.board.reset({color:$(this).attr("data-color")}),a.preventDefault()})},DrawingBoard.Control.Colors.prototype={rgba:function(a,b,c,d){return{r:a,g:b,b:c,a:d,toString:function(){return"rgba("+a+", "+b+", "+c+", "+d+")"}}},hsl:function(a,b,c){return{h:a,s:b,l:c,toString:function(){return"hsl("+a+", "+b*100+"%, "+c*100+"%)"}}},hex2Rgba:function(a){var b=parseInt(a.substring(1),16);return this.rgba(b>>16,b>>8&255,b&255,1)},hsl2Rgba:function(a){function h(a,b,c){return c<0&&(c+=1),c>1&&(c-=1),c<1/6?a+(b-a)*6*c:c<.5?b:c<2/3?a+(b-a)*(2/3-c)*6:a}var b=a.h/360,c=a.s,d=a.l,e,f,g;if(c===0)e=f=g=d;else{var i=d<.5?d*(1+c):d+c-d*c,j=2*d-i;e=Math.floor(h(j,i,b+1/3)*255),f=Math.floor(h(j,i,b)*255),g=Math.floor(h(j,i,b-1/3)*255)}return this.rgba(e,f,g,1)},fillWithRainbow:function(a){var b=0,c=null,d='<div class="drawing-board-control-colors-picker" data-color="{{color}}" style="background-color: {{color}}"></div>';this.el+='<div class="drawing-board-control-colors-rainbow">',a==.25&&(c=this.rgba(0,0,0,1)),a==.5&&(c=this.rgba(150,150,150,1)),a==.75&&(c=this.rgba(255,255,255,1)),c!==null&&(this.el+=DrawingBoard.Utils.tpl(d,{color:c.toString()}));while(b<=330)this.el+=DrawingBoard.Utils.tpl(d,{color:this.hsl2Rgba(this.hsl(b-60,1,a)).toString()}),b+=30;this.el+="</div>"}},DrawingBoard.Control.Navigation=function(a,b){this.board=a,this.opts=$.extend({backButton:!0,forwardButton:!0,resetButton:!0},b);var c=this,d='<div class="drawing-board-control drawing-board-control-navigation">';this.opts.backButton&&(d+='<button class="drawing-board-control-navigation-back" title="Annuler la dernière action">&larr;</button>'),this.opts.forwardButton&&(d+='<button class="drawing-board-control-navigation-forward" title="Recommencer la dernière action">&rarr;</button>'),this.opts.resetButton&&(d+='<button class="drawing-board-control-navigation-reset" title="Effacer tout">×</button>'),d+="</div>",this.$el=$(d),this.opts.backButton&&this.$el.on("click",".drawing-board-control-navigation-back",function(a){c.board.goBackInHistory(),a.preventDefault()}),this.opts.forwardButton&&this.$el.on("click",".drawing-board-control-navigation-forward",function(a){c.board.goForthInHistory(),a.preventDefault()}),this.opts.resetButton&&this.$el.on("click",".drawing-board-control-navigation-reset",function(a){c.board.reset(),a.preventDefault()})},DrawingBoard.Control.Size=function(a){this.board=a;var b=this,c='<div class="drawing-board-control drawing-board-control-size" title="Taille du pinceau : 10"><input type="range" min="1" max="50" value="10" class="drawing-board-control-size-input"><span class="drawing-board-control-size-label"></span></div>';this.$el=$(c),this.$el.on("change","input",function(a){b.updateView($(this).val()),a.preventDefault()}),this.updateView(this.$el.find("input").val())},DrawingBoard.Control.Size.prototype.updateView=function(a){this.board.ctx.lineWidth=a,this.$el.find(".drawing-board-control-size-label").css({width:a+"px",height:a+"px",borderRadius:a+"px"}),this.$el.attr("title","Taille du pinceau : "+a)};